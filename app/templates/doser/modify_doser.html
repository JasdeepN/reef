{% extends 'jqgrid-template.html' %}

{% block page_title %} Modify Doser {% endblock %}
{% block scripts %}
  {{super()}}
{% endblock %}
{% block content %}
<div class="applet-container">
  <div class="grid-container">
    <!-- Products Table -->
    <div class="grid-item">
      <div class="title">
        <h3>Products Table</h3>
      </div>
      <div class="content table-container">
        <div id="productsGridBox">
          <table id="productsTable"></table>
          <div id="productsTablePager"></div>
        </div>
      </div>
    </div>

    <!-- Manual Dosing Table -->
    <div class="grid-item">
      <div class="title">
        <h3>Manual Dosing Table</h3>
      </div>
      <div class="content table-container">
        <div id="manualDosingGridBox">
          <table id="manual_DosingTable"></table>
          <div id="manual_DosingTablePager"></div>
        </div>
      </div>
    </div>

    <!-- Placeholder for another table -->
    <div class="grid-item full-width">
      <div class="title">
        <h3>Another Table</h3>
      </div>
      <div class="content table-container">
        <div id="anotherGridBox">
          <table id="anotherTable"></table>
          <div id="anotherPager"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}



{% block page_scripts %}
  {{super()}}
  <script>
    $(document).ready(function () {
      // Initialize jqGrid for Products Table
      $("#productsTable").jqGrid({
        url: "/api/get/products",
        datatype: "json",
        mtype: "GET",
        colModel: [
          { label: "Name", name: "name", editable: true, formatoptions: { defaultValue: '' } },
          { label: "Dose Amount", name: "dose_amt", editable: true, formatoptions: { defaultValue: '' } },
          { label: "Total Volume", name: "total_volume", editable: true, formatoptions: { defaultValue: '' } },
          { label: "Current Available", name: "current_avail", editable: true, formatoptions: { defaultValue: '' } },
          { label: "Used Amount", name: "used_amt", editable: false },
        ],
        pager: "#productsTablePager",
        rowNum: 5,
        rowList: [5, 10, 15],
        sortname: "id",
        sortorder: "desc",
        viewrecords: true,
        caption: "Editable Products Table",
        editurl: "/api/edit_products",
      });

      // Add navigation buttons to the Products Table pager
      $("#productsTable").jqGrid("navGrid", "#productsTablePager", {
        edit: false, // Disable default edit button
        add: false, // Disable default add button
        del: false, // Disable default delete button
        search: false, // Disable default search button
        refresh: true, // Enable refresh button
      });

      // Add custom buttons to the Products Table pager
      $("#productsTable").jqGrid("navButtonAdd", "#productsTablePager", {
        caption: "Add",
        buttonicon: "ui-icon-plus",
        onClickButton: function () {
          alert("Add button clicked for Products Table!");
          // Add your custom logic for adding a row here
        },
        position: "last",
        title: "Add a new product",
        cursor: "pointer",
      });

      $("#productsTable").jqGrid("navButtonAdd", "#productsTablePager", {
        caption: "Delete",
        buttonicon: "ui-icon-trash",
        onClickButton: function () {
          const selectedRowId = $("#productsTable").jqGrid("getGridParam", "selrow");
          if (selectedRowId) {
            if (confirm("Are you sure you want to delete this record?")) {
              $.ajax({
                url: "/api/edit_products",
                type: "DELETE",
                contentType: "application/json",
                data: JSON.stringify({ id: selectedRowId }),
                success: function () {
                  alert("Record deleted successfully!");
                  $("#productsTable").trigger("reloadGrid");
                },
                error: function (xhr) {
                  alert("Error deleting record: " + xhr.responseText);
                },
              });
            }
          } else {
            alert("Please select a row to delete.");
          }
        },
        position: "last",
        title: "Delete the selected product",
        cursor: "pointer",
      });

      // Initialize jqGrid for Manual Dosing Table
      $("#manual_DosingTable").jqGrid({
        url: "/api/get/manual_dosing",
        datatype: "json",
        mtype: "GET",
        colModel: [
          { label: "Added On", name: "added_on", editable: true, sorttype: "date", formatoptions: { defaultValue: new Date().toISOString().split('T')[0] } },
          { label: "Dosed At", name: "dosed_at", editable: true, formatoptions: { defaultValue: new Date().toISOString().split('T')[1].slice(0, 8) } },
          { label: "Product", name: "product", editable: true, formatoptions: { defaultValue: '' } },
          { label: "Amount", name: "amount", editable: true, formatoptions: { defaultValue: '' } },
          { label: "Reason", name: "reason", editable: true, formatoptions: { defaultValue: '' } },
        ],
        pager: "#manual_DosingTablePager",
        rowNum: 5,
        rowList: [5, 10, 15],
        sortname: "id",
        sortorder: "desc",
        viewrecords: true,
        caption: "Editable Manual Dosing Table",
        editurl: "/api/edit_manual_dosing",
      });

      // Add navigation buttons to the Manual Dosing Table pager
      $("#manual_DosingTable").jqGrid("navGrid", "#manual_DosingTablePager", {
        edit: false,
        add: false,
        del: false,
        search: false,
        refresh: true,
      });

      // Add custom buttons to the Manual Dosing Table pager
      $("#manual_DosingTable").jqGrid("navButtonAdd", "#manual_DosingTablePager", {
        caption: "Add",
        buttonicon: "ui-icon-plus",
        onClickButton: function () {
          alert("Add button clicked for Manual Dosing Table!");
          // Add your custom logic for adding a row here
        },
        position: "last",
        title: "Add a new manual dosing entry",
        cursor: "pointer",
      });

      $("#manual_DosingTable").jqGrid("navButtonAdd", "#manual_DosingTablePager", {
        caption: "Delete",
        buttonicon: "ui-icon-trash",
        onClickButton: function () {
          const selectedRowId = $("#manual_DosingTable").jqGrid("getGridParam", "selrow");
          if (selectedRowId) {
            if (confirm("Are you sure you want to delete this record?")) {
              $.ajax({
                url: "/api/edit_manual_dosing",
                type: "DELETE",
                contentType: "application/json",
                data: JSON.stringify({ id: selectedRowId }),
                success: function () {
                  alert("Record deleted successfully!");
                  $("#manual_DosingTable").trigger("reloadGrid");
                },
                error: function (xhr) {
                  alert("Error deleting record: " + xhr.responseText);
                },
              });
            }
          } else {
            alert("Please select a row to delete.");
          }
        },
        position: "last",
        title: "Delete the selected manual dosing entry",
        cursor: "pointer",
      });
    });
  </script>
{% endblock %}