{% extends 'base.html' %}
{% from "macros/schedule_stats_cards.html" import schedule_stats_cards %}

{% block page_title %}Dosing Schedule Manager{% endblock %}

{% block content %}
<div class="container-fluid schedule-new-page">
  <div class="row">
    <!-- Create New Schedule Form -->
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">üìÖ Create New Dosing Schedule - Tank {{ tank_id }}</h5>
        </div>
        <div class="card-body">
          <form id="scheduleForm">
            <!-- Product Selection -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="product_id" class="form-label">üíä Product *</label>
                <select class="form-select" id="product_id" name="product_id" required>
                  <option value="">Select a product...</option>
                  {% for product in products %}
                  <option value="{{ product.id }}" data-avail="{{ product.current_avail }}">
                    {{ product.name }} (Available: {{ product.current_avail }}ml)
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="amount" class="form-label">üìè Amount (ml) *</label>
                <input type="number" step="0.1" min="0.1" class="form-control" id="amount" name="amount" required>
                <div class="form-text">Amount to dose each time</div>
              </div>
            </div>

            <!-- Doser Selection -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="doser_id" class="form-label">üîß Doser</label>
                <select class="form-select" id="doser_id" name="doser_id">
                  <option value="">No specific doser</option>
                  {% for doser in dosers %}
                  <option value="{{ doser.id }}" data-type="{{ doser.doser_type }}" data-max-daily="{{ doser.max_daily_volume }}">
                    {{ doser.doser_name }} ({{ doser.doser_type }})
                    {% if doser.max_daily_volume %} - Max: {{ doser.max_daily_volume }}ml/day{% endif %}
                  </option>
                  {% endfor %}
                </select>
                <div class="form-text">Optional: Assign to specific physical doser</div>
              </div>
              <div class="col-md-6">
                <label for="doser_name" class="form-label">‚öôÔ∏è Doser Name (Legacy)</label>
                <input type="text" class="form-control" id="doser_name" name="doser_name" maxlength="64">
                <div class="form-text">Optional: Manual doser identification</div>
              </div>
            </div>

            <!-- Schedule Type Selection -->
            <div class="mb-3">
              <label class="form-label">‚è∞ Schedule Type *</label>
              <div class="row">
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="schedule_type" id="type_interval" value="interval" checked>
                    <label class="form-check-label" for="type_interval">
                      Regular Intervals
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="schedule_type" id="type_daily" value="daily">
                    <label class="form-check-label" for="type_daily">
                      Daily Schedule
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="schedule_type" id="type_weekly" value="weekly">
                    <label class="form-check-label" for="type_weekly">
                      Weekly Schedule
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="schedule_type" id="type_custom" value="custom">
                    <label class="form-check-label" for="type_custom">
                      Custom (Advanced)
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Schedule Configuration -->
            <div class="card mb-3">
              <div class="card-body">
                <!-- Interval Schedule -->
                <div id="interval_config" class="schedule-config">
                  <h6 class="card-title">Regular Interval Configuration</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <label for="interval_value" class="form-label">Every</label>
                      <input type="number" min="1" max="10080" class="form-control" id="interval_value" name="interval_value" value="1">
                    </div>
                    <div class="col-md-6">
                      <label for="interval_unit" class="form-label">Unit</label>
                      <select class="form-select" id="interval_unit" name="interval_unit">
                        <option value="minutes">Minutes (min 1, max 10080)</option>
                        <option value="hours" selected>Hours (min 1, max 168)</option>
                        <option value="days">Days (min 1, max 7)</option>
                      </select>
                    </div>
                  </div>
                  <div class="row mt-2">
                    <div class="col-md-6">
                      <label for="start_time" class="form-label">‚è∞ Start Time (optional)</label>
                      <input type="time" class="form-control" id="start_time" name="start_time">
                      <div class="form-text">When to start the first dose (leave empty to start immediately)</div>
                    </div>
                    <div class="col-md-6">
                      <label for="offset_minutes" class="form-label">üîÑ Offset (minutes)</label>
                      <input type="number" class="form-control" id="offset_minutes" name="offset_minutes" min="-1440" max="1440" value="0">
                      <div class="form-text">Adjust timing by ¬± minutes (advanced)</div>
                    </div>
                  </div>
                  <div class="form-text mt-2">
                    ‚è±Ô∏è <strong>Example:</strong> "Every 2 hours" will dose the specified amount every 2 hours starting from when the schedule is activated.
                  </div>
                </div>

                <!-- Daily Schedule -->
                <div id="daily_config" class="schedule-config" style="display: none;">
                  <h6 class="card-title">Daily Schedule Configuration</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <label for="daily_time" class="form-label">üïê Dose Time</label>
                      <input type="time" class="form-control" id="daily_time" name="daily_time" value="09:00">
                      <div class="form-text">What time each day to dose</div>
                    </div>
                    <div class="col-md-6">
                      <label for="times_per_day" class="form-label">Times per Day</label>
                      <input type="number" min="1" max="24" class="form-control" id="times_per_day" name="times_per_day" value="1">
                      <div class="form-text">Number of doses per day (evenly spaced)</div>
                    </div>
                  </div>
                  <div class="form-text mt-2">
                    üìÖ <strong>Example:</strong> "09:00 daily" doses at 9 AM every day. "3 times per day" doses every 8 hours starting at selected time.
                  </div>
                </div>

                <!-- Weekly Schedule -->
                <div id="weekly_config" class="schedule-config" style="display: none;">
                  <h6 class="card-title">Weekly Schedule Configuration</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <label for="weekly_time" class="form-label">üïê Dose Time</label>
                      <input type="time" class="form-control" id="weekly_time" name="weekly_time" value="09:00">
                      <div class="form-text">What time to dose on selected days</div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">üìÖ Days of Week</label>
                      <div class="row">
                        <div class="col-6">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dow_1" name="days_of_week" value="1">
                            <label class="form-check-label" for="dow_1">Mon</label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dow_2" name="days_of_week" value="2">
                            <label class="form-check-label" for="dow_2">Tue</label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dow_3" name="days_of_week" value="3">
                            <label class="form-check-label" for="dow_3">Wed</label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dow_4" name="days_of_week" value="4">
                            <label class="form-check-label" for="dow_4">Thu</label>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dow_5" name="days_of_week" value="5">
                            <label class="form-check-label" for="dow_5">Fri</label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dow_6" name="days_of_week" value="6">
                            <label class="form-check-label" for="dow_6">Sat</label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dow_7" name="days_of_week" value="7">
                            <label class="form-check-label" for="dow_7">Sun</label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="form-text mt-2">
                    üìä <strong>Example:</strong> "Mon, Wed, Fri at 09:00" doses at 9 AM on those specific days each week.
                  </div>
                </div>

                <!-- Custom Schedule -->
                <div id="custom_config" class="schedule-config" style="display: none;">
                  <h6 class="card-title">Custom Schedule Configuration</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <label for="repeat_every_n_days" class="form-label">Repeat Every N Days</label>
                      <input type="number" min="1" max="365" class="form-control" id="repeat_every_n_days" name="repeat_every_n_days" value="1">
                      <div class="form-text">Dose every N days at specified time</div>
                    </div>
                    <div class="col-md-6">
                      <label for="custom_time" class="form-label">üïê Dose Time</label>
                      <input type="time" class="form-control" id="custom_time" name="custom_time" value="09:00">
                      <div class="form-text">Time of day to dose</div>
                    </div>
                  </div>
                  <div class="row mt-2">
                    <div class="col-md-6">
                      <label for="custom_seconds" class="form-label">OR Interval (seconds)</label>
                      <input type="number" min="60" class="form-control" id="custom_seconds" name="custom_seconds" value="3600">
                      <div class="form-text">Alternative: exact seconds interval</div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Human Readable</label>
                      <input type="text" class="form-control" id="custom_display" readonly>
                    </div>
                  </div>
                  <div class="form-text mt-2">
                    ‚öôÔ∏è <strong>Advanced:</strong> Use either day-based scheduling or exact second intervals.
                  </div>
                </div>
              </div>
            </div>

            <!-- Additional Options -->
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="suspended" name="suspended">
                  <label class="form-check-label" for="suspended">
                    ‚è∏Ô∏è Start Suspended
                  </label>
                </div>
                <div class="form-text">Schedule will be created but not active until manually enabled</div>
              </div>
            </div>

            <!-- Missed Dose Handling Configuration -->
            <div class="card mb-3 border-info">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0">‚ö†Ô∏è Missed Dose Handling</h6>
              </div>
              <div class="card-body">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="missed_dose_handling" class="form-label">Strategy *</label>
                    <select class="form-select" id="missed_dose_handling" name="missed_dose_handling" required>
                      <option value="alert_only" selected>Alert Only (Skip missed doses)</option>
                      <option value="grace_period">Grace Period (Allow within time window)</option>
                      <option value="manual_approval">Manual Approval Required</option>
                    </select>
                    <div class="form-text">How to handle doses that are missed</div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check mt-4">
                      <input class="form-check-input" type="checkbox" id="missed_dose_notification_enabled" name="missed_dose_notification_enabled" checked>
                      <label class="form-check-label" for="missed_dose_notification_enabled">
                        üîî Enable Missed Dose Notifications
                      </label>
                    </div>
                  </div>
                </div>

                <div class="row missed-dose-options" id="grace-period-options" style="display: none;">
                  <div class="col-md-6">
                    <label for="missed_dose_grace_period_hours" class="form-label">Grace Period (hours)</label>
                    <input type="number" class="form-control" id="missed_dose_grace_period_hours" name="missed_dose_grace_period_hours" value="12" min="1" max="72">
                    <div class="form-text">Allow dosing within this many hours after scheduled time</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create Schedule
              </button>
            </div>
          </form>
        </div>
      </div>

    </div>

    <!-- Existing Schedules -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">üìã Current Schedules</h5>
        </div>
        <div class="card-body">
          <div id="existingSchedules">
            {% if existing_schedules %}
              {% for schedule in existing_schedules %}
              <div class="card mb-2">
                <div class="card-body py-2">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="card-title mb-1">{{ schedule.product_name }}</h6>
                      <small class="text-muted">
                        {{ schedule.amount }}ml every {{ (schedule.trigger_interval / 3600) | round(1) }} hours<br>
                        {% if schedule.suspended %}<span class="badge bg-warning">Suspended</span>{% endif %}
                        {% if schedule.last_refill %}Last refill: {{ schedule.last_refill[:10] }}{% endif %}
                      </small>
                    </div>
                    <div class="btn-group-vertical btn-group-sm">
                      <a href="{{ url_for('schedule_edit', schedule_id=schedule.id) }}" class="btn btn-outline-primary btn-sm">‚úèÔ∏è Edit</a>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            {% else %}
              <p class="text-muted">No existing schedules for this tank.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Quick Reference -->
      <div class="card mt-3">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0">üìñ Quick Reference</h6>
        </div>
        <div class="card-body py-2">
          <small>
            <strong>Common Intervals:</strong><br>
            ‚Ä¢ Every 15 minutes = 96 times/day<br>
            ‚Ä¢ Every hour = 24 times/day<br>
            ‚Ä¢ Every 6 hours = 4 times/day<br>
            ‚Ä¢ Twice daily = 12 hour intervals<br>
            ‚Ä¢ Daily = 24 hour intervals<br>
            <br>
            <strong>Note:</strong> Minimum interval is 1 minute (60 seconds)
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Statistics - 3 Column Layout -->
  <div class="mt-4">
    {{ schedule_stats_cards(stats_api_urls["GET"], stats_api_urls["DELETE"], 'columns') }}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const scheduleTypeInputs = document.querySelectorAll('input[name="schedule_type"]');
  const scheduleConfigs = document.querySelectorAll('.schedule-config');

  // Handle schedule type changes
  scheduleTypeInputs.forEach(input => {
    input.addEventListener('change', function() {
      // Hide all configs
      scheduleConfigs.forEach(config => config.style.display = 'none');
      
      // Show selected config
      const selectedConfig = document.getElementById(this.value + '_config');
      if (selectedConfig) {
        selectedConfig.style.display = 'block';
      }
    });
  });

  // Update interval calculations for daily/weekly schedules
  document.getElementById('times_per_day').addEventListener('input', function() {
    const times = parseInt(this.value) || 1;
    const interval = Math.floor(86400 / times); // 86400 seconds in a day
    const hours = Math.floor(interval / 3600);
    const minutes = Math.floor((interval % 3600) / 60);
    document.getElementById('daily_interval_display').value = `${hours}h ${minutes}m (${interval}s)`;
  });

  document.getElementById('times_per_week').addEventListener('input', function() {
    const times = parseInt(this.value) || 1;
    const interval = Math.floor(604800 / times); // 604800 seconds in a week
    const days = Math.floor(interval / 86400);
    const hours = Math.floor((interval % 86400) / 3600);
    const minutes = Math.floor((interval % 3600) / 60);
    document.getElementById('weekly_interval_display').value = `${days}d ${hours}h ${minutes}m (${interval}s)`;
  });

  document.getElementById('custom_seconds').addEventListener('input', function() {
    const seconds = parseInt(this.value) || 60;
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    let display = '';
    if (days > 0) display += `${days}d `;
    if (hours > 0) display += `${hours}h `;
    if (minutes > 0) display += `${minutes}m `;
    if (secs > 0) display += `${secs}s`;
    
    document.getElementById('custom_display').value = display.trim();
  });

  // Initialize displays
  document.getElementById('times_per_day').dispatchEvent(new Event('input'));
  document.getElementById('times_per_week').dispatchEvent(new Event('input'));
  document.getElementById('custom_seconds').dispatchEvent(new Event('input'));

  // Handle missed dose strategy changes
  function updateMissedDoseConfig() {
    const strategy = document.getElementById('missed_dose_handling').value;
    const gracePeriodOptions = document.getElementById('grace-period-options');
    
    // Hide all options by default
    gracePeriodOptions.style.display = 'none';
    
    // Show relevant options based on strategy
    if (strategy === 'grace_period') {
      gracePeriodOptions.style.display = 'block';
    }
  }
  
  // Add event listener for missed dose strategy changes
  document.getElementById('missed_dose_handling').addEventListener('change', updateMissedDoseConfig);
  
  // Initialize missed dose config display
  updateMissedDoseConfig();

  // Doser validation function
  function validateDoserSelection() {
    const doserId = document.getElementById('doser_id').value;
    const doserName = document.getElementById('doser_name').value;
    
    if (!doserId && !doserName.trim()) {
      return { valid: false, message: 'Please select a doser or enter a legacy doser name.' };
    }
    
    return { valid: true };
  }

  // Schedule type validation
  function validateScheduleConfig() {
    const scheduleType = document.querySelector('input[name="schedule_type"]:checked').value;
    
    switch (scheduleType) {
      case 'daily':
        const timesPerDay = parseInt(document.getElementById('times_per_day').value);
        if (timesPerDay < 1 || timesPerDay > 24) {
          return { valid: false, message: 'Times per day must be between 1 and 24.' };
        }
        break;
        
      case 'weekly':
        const daysSelected = document.querySelectorAll('input[name="days_of_week"]:checked');
        if (daysSelected.length === 0) {
          return { valid: false, message: 'Please select at least one day of the week.' };
        }
        break;
        
      case 'custom':
        const repeatDays = parseInt(document.getElementById('repeat_every_n_days').value);
        const customSeconds = parseInt(document.getElementById('custom_seconds').value);
        
        if (repeatDays && (repeatDays < 1 || repeatDays > 365)) {
          return { valid: false, message: 'Repeat days must be between 1 and 365.' };
        }
        
        if (customSeconds && customSeconds < 60) {
          return { valid: false, message: 'Custom interval must be at least 60 seconds.' };
        }
        break;
        
      case 'interval':
        const amount = parseFloat(document.getElementById('amount').value);
        const intervalMinutes = parseInt(document.getElementById('trigger_interval').value);
        
        if (!amount || amount <= 0) {
          return { valid: false, message: 'Amount must be greater than 0.' };
        }
        
        if (!intervalMinutes || intervalMinutes < 1) {
          return { valid: false, message: 'Interval must be at least 1 minute.' };
        }
        break;
    }
    
    return { valid: true };
  }

  // Enhanced form submission with validation
  document.getElementById('scheduleForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate doser selection
    const doserValidation = validateDoserSelection();
    if (!doserValidation.valid) {
      alert('‚ùå ' + doserValidation.message);
      return;
    }
    
    // Validate schedule configuration
    const scheduleValidation = validateScheduleConfig();
    if (!scheduleValidation.valid) {
      alert('‚ùå ' + scheduleValidation.message);
      return;
    }
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    // Add the selected schedule type data
    const scheduleType = document.querySelector('input[name="schedule_type"]:checked').value;
    data.schedule_type = scheduleType;
    
    // Handle days of week for weekly schedule
    if (scheduleType === 'weekly') {
      const selectedDays = Array.from(document.querySelectorAll('input[name="days_of_week"]:checked'))
        .map(checkbox => checkbox.value);
      data.days_of_week = selectedDays.join(',');
    }
    
    // Convert checkbox values
    data.suspended = document.getElementById('suspended').checked;
    data.missed_dose_notification_enabled = document.getElementById('missed_dose_notification_enabled').checked;

    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    submitBtn.disabled = true;

    fetch('/doser/schedule/new', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        alert('‚úÖ Dosing schedule created successfully!');
        resetForm();
        // Optionally reload the page to show the new schedule
        location.reload();
      } else {
        alert('‚ùå Error creating schedule: ' + result.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('‚ùå Network error occurred while creating schedule.');
    })
    .finally(() => {
      // Restore button state
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    });
  });
});

function resetForm() {
  document.getElementById('scheduleForm').reset();
  document.querySelector('input[name="schedule_type"][value="interval"]').checked = true;
  document.querySelector('input[name="schedule_type"][value="interval"]').dispatchEvent(new Event('change'));
  
  // Reset displays
  document.getElementById('times_per_day').dispatchEvent(new Event('input'));
  document.getElementById('times_per_week').dispatchEvent(new Event('input'));
  document.getElementById('custom_seconds').dispatchEvent(new Event('input'));
}
</script>
{% endblock %}

{% block styles %}
<style>
.schedule-config {
  transition: all 0.3s ease-in-out;
}

.card-title {
  color: #495057;
  font-weight: 600;
}

.form-text {
  font-size: 0.875rem;
}

.badge {
  font-size: 0.75rem;
}

#existingSchedules .card {
  border-left: 4px solid #28a745;
}

#existingSchedules .card:has(.badge) {
  border-left-color: #ffc107;
}

/* Force Bootstrap grid layout */
.schedule-new-page .row {
  display: flex !important;
  flex-wrap: wrap !important;
}

.schedule-new-page [class*="col-"] {
  display: flex !important;
  flex-direction: column !important;
}

.schedule-new-page .container-fluid {
  padding-left: 15px;
  padding-right: 15px;
}

/* Ensure cards take full height in columns */
.schedule-new-page .col-lg-8 .card,
.schedule-new-page .col-lg-4 .card {
  flex: 1;
}
</style>

{% endblock %}
