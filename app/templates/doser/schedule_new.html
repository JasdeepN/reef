{% extends 'base.html' %}
{% from "macros/schedule_stats_cards.html" import schedule_stats_cards %}

{% block page_title %}Simple Dosing Schedule{% endblock %}

{% block content %}
<div class="container-fluid schedule-new-page">
  <div class="row">
    <!-- Create New Schedule Form -->
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">üìÖ Create Simple Dosing Schedule - System {{ system_name }}</h5>
          <small class="text-light">Create interval-based dosing schedules with precise timing</small>
        </div>
        <div class="card-body">
          <form id="scheduleForm">
            <!-- Product Selection -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="product_id" class="form-label">üíä Product *</label>
                <select class="form-select" id="product_id" name="product_id" required>
                  <option value="">Select a product...</option>
                  {% for product in products %}
                  <option value="{{ product.id }}" data-avail="{{ product.current_avail }}">
                    {{ product.name }} (Available: {{ product.current_avail }}ml)
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="amount" class="form-label">üìè Amount (ml) *</label>
                <input type="number" step="0.1" min="0.1" class="form-control" id="amount" name="amount" required>
                <div class="form-text">Amount to dose each time</div>
              </div>
            </div>

            <!-- Doser Selection -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="doser_id" class="form-label">üîß Doser</label>
                <select class="form-select" id="doser_id" name="doser_id">
                  <option value="">No specific doser</option>
                  {% for doser in dosers %}
                  <option value="{{ doser.id }}" data-type="{{ doser.doser_type }}" data-max-daily="{{ doser.max_daily_volume }}">
                    {{ doser.doser_name }} ({{ doser.doser_type }})
                    {% if doser.max_daily_volume %} - Max: {{ doser.max_daily_volume }}ml/day{% endif %}
                  </option>
                  {% endfor %}
                </select>
                <div class="form-text">Optional: Assign to specific physical doser</div>
              </div>
              <div class="col-md-6">
                <label for="doser_name" class="form-label">‚öôÔ∏è Doser Name (Legacy)</label>
                <input type="text" class="form-control" id="doser_name" name="doser_name" maxlength="64">
                <div class="form-text">Optional: Manual doser identification</div>
              </div>
            </div>

            <!-- Simple Interval Schedule -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0">‚è∞ Dosing Schedule</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <label for="interval_value" class="form-label">Dose Every *</label>
                    <input type="number" min="1" max="1440" class="form-control" id="interval_value" name="interval_value" value="8" required>
                  </div>
                  <div class="col-md-6">
                    <label for="interval_unit" class="form-label">Time Unit *</label>
                    <select class="form-select" id="interval_unit" name="interval_unit" required>
                      <option value="minutes">Minutes (1-1440)</option>
                      <option value="hours" selected>Hours (1-24)</option>
                      <option value="days">Days (1-7)</option>
                    </select>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-md-6">
                    <label for="start_time" class="form-label">‚è∞ Start Time (optional)</label>
                    <input type="time" class="form-control" id="start_time" name="start_time">
                    <div class="form-text">When to start the first dose (leave empty to start immediately)</div>
                  </div>
                  <div class="col-md-6">
                    <label for="hour_offset" class="form-label">üïê Hour Offset (for hourly schedules)</label>
                    <div class="input-group">
                      <span class="input-group-text">:</span>
                      <input type="number" min="0" max="59" class="form-control" id="hour_offset" name="hour_offset"
                             value="0" placeholder="Minutes past hour">
                      <span class="input-group-text">minutes</span>
                    </div>
                    <div class="form-text">
                      <strong>Hourly schedules only:</strong> Dose at :XX minutes past each hour<br>
                      <small>Examples: 0 = :00 (top of hour), 30 = :30 (half past), 45 = :45</small>
                    </div>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-md-12">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="suspended" name="suspended">
                      <label class="form-check-label" for="suspended">
                        ‚è∏Ô∏è Start Suspended
                      </label>
                      <div class="form-text">Schedule will be created but not active until manually enabled</div>
                    </div>
                  </div>
                </div>
                <div class="mt-3">
                  <div class="alert alert-info">
                    <strong>Example:</strong> Every <span id="interval_display">8 hours</span>, dose <span id="amount_display">0</span>ml <span id="start_display">immediately</span>.
                    <br><small class="text-muted">Daily total: approximately <span id="daily_total">0</span>ml</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <button type="button" class="btn btn-secondary" onclick="resetForm()">
                <i class="fas fa-undo"></i> Reset
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create Schedule
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Existing Schedules -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">üìã Current Schedules</h5>
        </div>
        <div class="card-body">
          <div id="existingSchedules">
            {% if existing_schedules %}
              {% for schedule in existing_schedules %}
              <div class="card mb-2">
                <div class="card-body py-2">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="card-title mb-1">{{ schedule.product_name }}</h6>
                      <small class="text-muted">
                        {{ schedule.amount }}ml every {{ (schedule.trigger_interval / 3600) | round(1) }} hours<br>
                        {% if schedule.suspended %}<span class="badge bg-warning">Suspended</span>{% endif %}
                        {% if schedule.last_refill %}Last refill: {{ schedule.last_refill[:10] }}{% endif %}
                      </small>
                    </div>
                    <div class="btn-group-vertical btn-group-sm">
                      <a href="{{ url_for('schedule_edit', schedule_id=schedule.id) }}" class="btn btn-outline-primary btn-sm">‚úèÔ∏è Edit</a>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            {% else %}
              <p class="text-muted">No existing schedules for this tank.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Quick Reference -->
      <div class="card mt-3">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0">üìñ Common Intervals</h6>
        </div>
        <div class="card-body py-2">
          <small>
            <strong>Popular Schedules:</strong><br>
            ‚Ä¢ Every 6 hours = 4 times/day<br>
            ‚Ä¢ Every 8 hours = 3 times/day<br>
            ‚Ä¢ Every 12 hours = 2 times/day<br>
            ‚Ä¢ Daily = 1 time/day<br>
            ‚Ä¢ Every 2 days = 3-4 times/week<br>
            <br>
            <strong>Precision:</strong> Timing accuracy ¬±1 second
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Statistics - 3 Column Layout -->
  <div class="mt-4">
    {{ schedule_stats_cards(stats_api_urls["GET"], stats_api_urls["DELETE"], 'columns') }}
  </div>
</div>

<!-- Loading Overlay -->
<div id="loading" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Creating schedule...</span>
  </div>
  <div class="mt-2">Creating dosing schedule...</div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('scheduleForm');
  const loadingDiv = document.getElementById('loading');

  // Show/hide hour offset field based on interval unit
  function toggleHourOffsetField() {
    const intervalUnit = document.getElementById('interval_unit').value;
    const hourOffsetGroup = document.getElementById('hour_offset_group');
    
    if (intervalUnit === 'hours') {
      hourOffsetGroup.style.display = 'block';
    } else {
      hourOffsetGroup.style.display = 'none';
    }
  }

  // Update display values when inputs change
  function updateDisplays() {
    const amount = parseFloat(document.getElementById('amount').value) || 0;
    const intervalValue = parseInt(document.getElementById('interval_value').value) || 1;
    const intervalUnit = document.getElementById('interval_unit').value;
    const startTime = document.getElementById('start_time').value;

    // Update amount display
    document.getElementById('amount_display').textContent = amount;

    // Update interval display
    let intervalText = `${intervalValue} ${intervalUnit}`;
    if (intervalValue === 1) {
      intervalText = intervalText.slice(0, -1); // Remove 's' for singular
    }
    document.getElementById('interval_display').textContent = intervalText;

    // Update start display
    if (startTime) {
      document.getElementById('start_display').textContent = `at ${startTime}`;
    } else {
      document.getElementById('start_display').textContent = 'immediately';
    }

    // Calculate daily total
    let dailyTotal = 0;
    if (amount > 0 && intervalValue > 0) {
      let hoursInterval;
      switch (intervalUnit) {
        case 'minutes':
          hoursInterval = intervalValue / 60;
          break;
        case 'hours':
          hoursInterval = intervalValue;
          break;
        case 'days':
          hoursInterval = intervalValue * 24;
          break;
      }
      dailyTotal = (24 / hoursInterval) * amount;
    }
    document.getElementById('daily_total').textContent = dailyTotal.toFixed(1);
  }

  // Add event listeners for real-time updates
  document.getElementById('amount').addEventListener('input', updateDisplays);
  document.getElementById('interval_value').addEventListener('input', updateDisplays);
  document.getElementById('interval_unit').addEventListener('change', function() {
    updateDisplays();
    toggleHourOffsetField();
  });
  document.getElementById('start_time').addEventListener('change', updateDisplays);

  // Initialize displays and field visibility
  updateDisplays();
  toggleHourOffsetField();

  // Form validation
  function validateForm() {
    const productId = document.getElementById('product_id').value;
    const amount = parseFloat(document.getElementById('amount').value);
    const intervalValue = parseInt(document.getElementById('interval_value').value);
    const intervalUnit = document.getElementById('interval_unit').value;
    const hourOffset = parseInt(document.getElementById('hour_offset').value);

    if (!productId) {
      return { valid: false, message: 'Please select a product.' };
    }

    if (!amount || amount <= 0) {
      return { valid: false, message: 'Please enter a valid amount greater than 0.' };
    }

    if (!intervalValue || intervalValue <= 0) {
      return { valid: false, message: 'Please enter a valid interval.' };
    }

    // Validate hour offset for hourly schedules
    if (intervalUnit === 'hours' && (isNaN(hourOffset) || hourOffset < 0 || hourOffset > 59)) {
      return { 
        valid: false, 
        message: 'Hour offset must be between 0 and 59 minutes for hourly schedules.' 
      };
    }

    // Validate interval ranges
    const maxValues = {
      'minutes': 1440, // 24 hours
      'hours': 24,     // 24 hours  
      'days': 7        // 7 days
    };

    if (intervalValue > maxValues[intervalUnit]) {
      return { 
        valid: false, 
        message: `Interval too large. Maximum for ${intervalUnit}: ${maxValues[intervalUnit]}` 
      };
    }

    return { valid: true };
  }

  // Form submission
  form.addEventListener('submit', function(e) {
    e.preventDefault();

    // Validate form
    const validation = validateForm();
    if (!validation.valid) {
      alert(validation.message);
      return;
    }

    // Show loading
    loadingDiv.style.display = 'block';
    form.style.opacity = '0.6';

    // Collect form data
    const formData = new FormData(form);
    const data = {};

    formData.forEach((value, key) => {
      if (value !== '') {
        data[key] = value;
      }
    });

    // Convert checkbox to boolean
    data.suspended = document.getElementById('suspended').checked;
    
    // Set schedule type to interval (simplified)
    data.schedule_type = 'interval';

    fetch('/doser/schedule/new', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
      loadingDiv.style.display = 'none';
      form.style.opacity = '1';

      if (data.success) {
        alert('Dosing schedule created successfully!');
        window.location.reload();
      } else {
        alert('Error creating schedule: ' + data.error);
      }
    })
    .catch(error => {
      loadingDiv.style.display = 'none';
      form.style.opacity = '1';
      alert('Error creating schedule: ' + error.message);
    });
  });
});

function resetForm() {
  document.getElementById('scheduleForm').reset();
  document.getElementById('interval_value').value = '8';
  document.getElementById('interval_unit').value = 'hours';
  document.getElementById('suspended').checked = false;
  
  // Update displays
  document.getElementById('amount').dispatchEvent(new Event('input'));
}
</script>
{% endblock %}
