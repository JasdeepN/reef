{% extends 'base.html' %}

{% block page_title %} Dosing Database {% endblock %}

{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/select/1.6.2/css/select.dataTables.min.css">
{% endblock %}

{% block content %}
<div class="dashboard-header">
  <h1>Dosing Database</h1>
  <p>View and manage dosing history records</p>
</div>

<div class="grid-container single-table">
  {% if tables is iterable and tables|length > 0 %}
    {% for table in tables %}
      <div class="grid-item full-width">
        <div class="title">
          <h3>{{ table.title | default("Dosing Data") }}</h3>
        </div>
        <div class="content table-container">
          <table id="{{ table.id }}" class="display" style="width:100%">
            <thead>
              <tr>
                {% for column in table.columns %}
                  <th>{{ column.label }}</th>
                {% endfor %}
              </tr>
            </thead>
          </table>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="grid-item full-width">
      <p>No dosing data to display.</p>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/select/1.6.2/js/dataTables.select.min.js"></script>
{% endblock %}

{% block page_scripts %}
<script>
$(document).ready(function () {
  {% if tables is iterable and tables|length > 0 %}
    {% for table in tables %}
      var options = {{ table.datatable_options | default({}) | tojson | safe }};
      var initialData = {{ table.initial_data | default([]) | tojson | safe }};
      
      // Configure DataTable based on serverSide option
      var tableConfig = {
        columns: [
          {% for column in table.columns %}
            { data: '{{ column.data }}' },
          {% endfor %}
        ],
        paging: true,
        searching: true,
        ordering: true,
        order: options.order || [[0, 'desc']],
        responsive: true,
        lengthMenu: [10, 25, 50, 100],
        language: {
          loadingRecords: "Loading...",
          emptyTable: "No records to display",
        },
        select: true,
        dom: options.dom || 'Bfrtip',
        buttons: options.buttons || []
      };

      // Handle serverSide vs client-side data
      if (options.serverSide === false && initialData.length > 0) {
        // Client-side: use initial data
        tableConfig.data = initialData;
        tableConfig.serverSide = false;
        tableConfig.processing = false;
      } else {
        // Server-side: use AJAX
        tableConfig.serverSide = true;
        tableConfig.processing = true;
        tableConfig.ajax = {
          url: '/web/fn/ops/get/{{ table.id }}',
          type: 'GET',
          data: function (d) {
            return {
              draw: d.draw,
              page: (d.start / d.length) + 1,
              rows: d.length,
              sidx: d.columns[d.order[0].column].data,
              sord: d.order[0].dir,
              search: d.search.value
            };
          }
        };
      }

      const table_{{ loop.index }} = $('#{{ table.id }}').DataTable(tableConfig);
    {% endfor %}
  {% endif %}
});
</script>
{% endblock %}
