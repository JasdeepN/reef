{% extends 'base.html' %}
{% from "macros/schedule_stats_cards.html" import schedule_stats_cards %}

{% block page_title %}Edit Dosing Schedule{% endblock %}

{% block content %}
<div class="container-fluid schedule-edit-page">
  <div class="row">
    <!-- Edit Schedule Form -->
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">‚úèÔ∏è Edit Dosing Schedule - {{ schedule.product_name }} (Tank {{ tank_id }})</h5>
        </div>
        <div class="card-body">
          <form id="scheduleForm">
            <!-- Product Selection -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="product_id" class="form-label">üíä Product *</label>
                <select class="form-select" id="product_id" name="product_id" required>
                  <option value="">Select a product...</option>
                  {% for product in products %}
                  <option value="{{ product.id }}" data-avail="{{ product.current_avail }}" 
                    {% if product.id == schedule.product_id %}selected{% endif %}>
                    {{ product.name }} (Available: {{ product.current_avail }}ml)
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="amount" class="form-label">üìè Amount (ml) *</label>
                <input type="number" step="0.1" min="0.1" class="form-control" id="amount" name="amount" 
                       value="{{ schedule.amount }}" required>
                <div class="form-text">Amount to dose each time</div>
              </div>
            </div>

            <!-- Schedule Type Selection -->
            <div class="mb-3">
              <label class="form-label">‚è∞ Schedule Type *</label>
              <div class="row">
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="schedule_type" id="type_interval" value="interval" checked>
                    <label class="form-check-label" for="type_interval">
                      Regular Intervals
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="schedule_type" id="type_daily" value="daily">
                    <label class="form-check-label" for="type_daily">
                      Daily
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="schedule_type" id="type_weekly" value="weekly">
                    <label class="form-check-label" for="type_weekly">
                      Weekly
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="schedule_type" id="type_custom" value="custom">
                    <label class="form-check-label" for="type_custom">
                      Custom
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Schedule Configuration Sections -->
            <!-- Regular Intervals -->
            <div class="schedule-config" id="interval_config">
              <div class="card bg-light mb-3">
                <div class="card-body">
                  <h6 class="card-title">Regular Interval Configuration</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <label for="interval_value" class="form-label">Every *</label>
                      <input type="number" min="1" class="form-control" id="interval_value" name="interval_value" value="8">
                    </div>
                    <div class="col-md-6">
                      <label for="interval_unit" class="form-label">Unit *</label>
                      <select class="form-select" id="interval_unit" name="interval_unit">
                        <option value="minutes">Minutes</option>
                        <option value="hours" selected>Hours</option>
                        <option value="days">Days</option>
                      </select>
                    </div>
                  </div>
                  <div class="mt-2">
                    <small class="text-muted">Current: Dose every <span id="interval_display">8 hours</span></small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Daily Schedule -->
            <div class="schedule-config" id="daily_config" style="display: none;">
              <div class="card bg-light mb-3">
                <div class="card-body">
                  <h6 class="card-title">Daily Schedule Configuration</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <label for="times_per_day" class="form-label">Times per Day *</label>
                      <input type="number" min="1" max="1440" class="form-control" id="times_per_day" name="times_per_day" value="3">
                    </div>
                  </div>
                  <div class="mt-2">
                    <small class="text-muted">Current: Dose <span id="daily_display">3 times per day</span> (every <span id="daily_interval">8 hours</span>)</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Weekly Schedule -->
            <div class="schedule-config" id="weekly_config" style="display: none;">
              <div class="card bg-light mb-3">
                <div class="card-body">
                  <h6 class="card-title">Weekly Schedule Configuration</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <label for="times_per_week" class="form-label">Times per Week *</label>
                      <input type="number" min="1" max="10080" class="form-control" id="times_per_week" name="times_per_week" value="21">
                    </div>
                  </div>
                  <div class="mt-2">
                    <small class="text-muted">Current: Dose <span id="weekly_display">21 times per week</span> (every <span id="weekly_interval">8 hours</span>)</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Custom Schedule -->
            <div class="schedule-config" id="custom_config" style="display: none;">
              <div class="card bg-light mb-3">
                <div class="card-body">
                  <h6 class="card-title">Custom Schedule Configuration</h6>
                  <div class="row">
                    <div class="col-md-4">
                      <label for="custom_hours" class="form-label">Hours</label>
                      <input type="number" min="0" max="23" class="form-control" id="custom_hours" name="custom_hours" value="8">
                    </div>
                    <div class="col-md-4">
                      <label for="custom_minutes" class="form-label">Minutes</label>
                      <input type="number" min="0" max="59" class="form-control" id="custom_minutes" name="custom_minutes" value="0">
                    </div>
                    <div class="col-md-4">
                      <label for="custom_seconds" class="form-label">Seconds</label>
                      <input type="number" min="0" max="59" class="form-control" id="custom_seconds" name="custom_seconds" value="0">
                    </div>
                  </div>
                  <div class="mt-2">
                    <small class="text-muted">Current: Dose every <span id="custom_display">8 hours 0 minutes 0 seconds</span></small>
                  </div>
                  <div class="mt-1">
                    <small class="text-info">üí° Minimum interval: 1 minute (60 seconds)</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Suspended Toggle -->
            <div class="mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="suspended" name="suspended" 
                       {% if schedule.suspended %}checked{% endif %}>
                <label class="form-check-label" for="suspended">
                  ‚è∏Ô∏è Suspend this schedule
                </label>
                <div class="form-text">Suspended schedules won't trigger automatically</div>
              </div>
            </div>

            <!-- Missed Dose Handling Configuration -->
            <div class="card mb-4">
              <div class="card-header">
                <h6 class="mb-0">‚è∞ Missed Dose Handling</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <label for="missed_dose_handling" class="form-label">When a dose is missed:</label>
                    <select class="form-select" id="missed_dose_handling" name="missed_dose_handling">
                      <option value="alert_only" {% if schedule.missed_dose_handling == 'alert_only' %}selected{% endif %}>
                        üö® Alert Only - Skip missed doses
                      </option>
                      <option value="grace_period" {% if schedule.missed_dose_handling == 'grace_period' %}selected{% endif %}>
                        ‚è∞ Grace Period - Allow dosing within time window
                      </option>
                      <option value="manual_approval" {% if schedule.missed_dose_handling == 'manual_approval' %}selected{% endif %}>
                        ‚úã Manual Approval - Require user confirmation
                      </option>
                    </select>
                  </div>
                  <div class="col-md-3" id="grace-period-config" style="display: none;">
                    <label for="missed_dose_grace_period_hours" class="form-label">Grace Period (hours)</label>
                    <input type="number" class="form-control" id="missed_dose_grace_period_hours" name="missed_dose_grace_period_hours" 
                           value="{{ schedule.missed_dose_grace_period_hours or 12 }}" min="1" max="72" step="1">
                    <div class="form-text">Allow dosing up to this many hours late</div>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-12">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="missed_dose_notification_enabled" 
                             name="missed_dose_notification_enabled" 
                             {% if schedule.missed_dose_notification_enabled %}checked{% endif %}>
                      <label class="form-check-label" for="missed_dose_notification_enabled">
                        üìß Enable missed dose notifications
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <a href="{{ url_for('schedule_new') }}" class="btn btn-secondary">Cancel</a>
              <button type="submit" class="btn btn-warning">üíæ Update Schedule</button>
            </div>

            <!-- Loading indicator -->
            <div id="loading" class="text-center mt-3" style="display: none;">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Updating...</span>
              </div>
              <div class="mt-2">Updating schedule...</div>
            </div>
          </form>
        </div>
      </div>

      <!-- Quick Reference Guide -->
      <div class="card mt-3">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0">üìñ Quick Reference</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6>Common Intervals</h6>
              <ul class="list-unstyled">
                <li><strong>2-part dosing:</strong> Every 12 hours</li>
                <li><strong>Calcium reactor:</strong> Every 6-8 hours</li>
                <li><strong>Trace elements:</strong> Daily or weekly</li>
                <li><strong>Amino acids:</strong> Every 2-3 days</li>
              </ul>
            </div>
            <div class="col-md-6">
              <h6>Tips</h6>
              <ul class="list-unstyled">
                <li>‚Ä¢ Start with conservative amounts</li>
                <li>‚Ä¢ Monitor consumption rates</li>
                <li>‚Ä¢ Adjust based on test results</li>
                <li>‚Ä¢ Use suspension for maintenance</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Existing Schedules Sidebar -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header bg-secondary text-white">
          <h6 class="mb-0">üìã Other Active Schedules</h6>
        </div>
        <div class="card-body">
          {% if existing_schedules %}
            {% for sched in existing_schedules %}
            <div class="card mb-2">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <strong>{{ sched.product_name }}</strong><br>
                    <small class="text-muted">{{ sched.amount }}ml every {{ (sched.trigger_interval / 3600) | round(1) }} hours</small>
                    {% if sched.suspended %}
                    <br><span class="badge bg-warning">Suspended</span>
                    {% endif %}
                  </div>
                  <div class="btn-group-vertical btn-group-sm">
                    <a href="{{ url_for('schedule_edit', schedule_id=sched.id) }}" class="btn btn-outline-primary btn-sm">Edit</a>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">No other schedules for this tank.</p>
          {% endif %}
        </div>
      </div>

      <!-- Product Statistics -->
      {{ schedule_stats_cards(stats_api_urls["GET"], stats_api_urls["DELETE"], enable_tooltips=false, filter_product_id=schedule.product_id) }}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('scheduleForm');
    const loadingDiv = document.getElementById('loading');
    const scheduleTypeRadios = document.querySelectorAll('input[name="schedule_type"]');
    
    // Pre-populate form based on existing schedule data
    const existingSchedule = {{ schedule | tojson }};
    console.log('Existing schedule:', existingSchedule);
    
    // Calculate which schedule type this interval represents
    function detectScheduleType(triggerInterval) {
        // Try to match common patterns
        const hours = triggerInterval / 3600;
        const days = triggerInterval / 86400;
        
        // Check if it's a clean hour interval (most common)
        if (triggerInterval % 3600 === 0 && hours <= 24) {
            return 'interval';
        }
        
        // Check if it divides evenly into daily intervals
        if (86400 % triggerInterval === 0) {
            return 'daily';
        }
        
        // Check if it divides evenly into weekly intervals
        if (604800 % triggerInterval === 0) {
            return 'weekly';
        }
        
        // Default to custom for irregular intervals
        return 'custom';
    }
    
    // Pre-populate based on existing trigger_interval
    const detectedType = detectScheduleType(existingSchedule.trigger_interval);
    document.getElementById('type_' + detectedType).checked = true;
    
    // Set values based on detected type
    if (detectedType === 'interval') {
        const hours = existingSchedule.trigger_interval / 3600;
        if (hours >= 24) {
            document.getElementById('interval_value').value = Math.round(hours / 24);
            document.getElementById('interval_unit').value = 'days';
        } else if (hours >= 1) {
            document.getElementById('interval_value').value = Math.round(hours);
            document.getElementById('interval_unit').value = 'hours';
        } else {
            document.getElementById('interval_value').value = Math.round(existingSchedule.trigger_interval / 60);
            document.getElementById('interval_unit').value = 'minutes';
        }
    } else if (detectedType === 'daily') {
        const timesPerDay = Math.round(86400 / existingSchedule.trigger_interval);
        document.getElementById('times_per_day').value = timesPerDay;
    } else if (detectedType === 'weekly') {
        const timesPerWeek = Math.round(604800 / existingSchedule.trigger_interval);
        document.getElementById('times_per_week').value = timesPerWeek;
    } else {
        // Custom - break down into hours, minutes, seconds
        const totalSeconds = existingSchedule.trigger_interval;
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        
        document.getElementById('custom_hours').value = hours;
        document.getElementById('custom_minutes').value = minutes;
        document.getElementById('custom_seconds').value = seconds;
    }
    
    // Show/hide schedule config sections
    function updateScheduleConfig() {
        const selectedType = document.querySelector('input[name="schedule_type"]:checked').value;
        
        // Hide all configs
        document.querySelectorAll('.schedule-config').forEach(config => {
            config.style.display = 'none';
        });
        
        // Show selected config
        document.getElementById(selectedType + '_config').style.display = 'block';
        
        // Update displays
        updateDisplays();
    }
    
    // Update interval displays
    function updateDisplays() {
        const selectedType = document.querySelector('input[name="schedule_type"]:checked').value;
        
        if (selectedType === 'interval') {
            const value = parseInt(document.getElementById('interval_value').value) || 0;
            const unit = document.getElementById('interval_unit').value;
            document.getElementById('interval_display').textContent = `${value} ${unit}`;
        } else if (selectedType === 'daily') {
            const times = parseInt(document.getElementById('times_per_day').value) || 0;
            const intervalHours = Math.round((24 / times) * 10) / 10;
            document.getElementById('daily_display').textContent = `${times} times per day`;
            document.getElementById('daily_interval').textContent = `${intervalHours} hours`;
        } else if (selectedType === 'weekly') {
            const times = parseInt(document.getElementById('times_per_week').value) || 0;
            const intervalHours = Math.round((168 / times) * 10) / 10;
            document.getElementById('weekly_display').textContent = `${times} times per week`;
            document.getElementById('weekly_interval').textContent = `${intervalHours} hours`;
        } else if (selectedType === 'custom') {
            const hours = parseInt(document.getElementById('custom_hours').value) || 0;
            const minutes = parseInt(document.getElementById('custom_minutes').value) || 0;
            const seconds = parseInt(document.getElementById('custom_seconds').value) || 0;
            document.getElementById('custom_display').textContent = `${hours} hours ${minutes} minutes ${seconds} seconds`;
        }
    }
    
    // Event listeners for schedule type changes
    scheduleTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateScheduleConfig);
    });
    
    // Event listeners for value changes
    document.getElementById('interval_value').addEventListener('input', updateDisplays);
    document.getElementById('interval_unit').addEventListener('change', updateDisplays);
    document.getElementById('times_per_day').addEventListener('input', updateDisplays);
    document.getElementById('times_per_week').addEventListener('input', updateDisplays);
    document.getElementById('custom_hours').addEventListener('input', updateDisplays);
    document.getElementById('custom_minutes').addEventListener('input', updateDisplays);
    document.getElementById('custom_seconds').addEventListener('input', updateDisplays);
    
    // Initialize display
    updateScheduleConfig();
    
    // Handle missed dose strategy changes
    const missedDoseHandlingSelect = document.getElementById('missed_dose_handling');
    const gracePeriodConfig = document.getElementById('grace-period-config');
    
    function updateMissedDoseConfig() {
        const strategy = missedDoseHandlingSelect.value;
        
        // Hide all config sections first
        gracePeriodConfig.style.display = 'none';
        
        // Show relevant config based on strategy
        if (strategy === 'grace_period') {
            gracePeriodConfig.style.display = 'block';
        }
    }
    
    missedDoseHandlingSelect.addEventListener('change', updateMissedDoseConfig);
    updateMissedDoseConfig(); // Initialize on page load
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading
        loadingDiv.style.display = 'block';
        form.style.opacity = '0.6';
        
        // Collect form data
        const formData = new FormData(form);
        const data = {};
        
        formData.forEach((value, key) => {
            if (value !== '') {
                data[key] = value;
            }
        });
        
        // Convert checkbox to boolean
        data.suspended = document.getElementById('suspended').checked;
        data.missed_dose_notification_enabled = document.getElementById('missed_dose_notification_enabled').checked;
        
        // Calculate custom_seconds for custom schedule type
        if (data.schedule_type === 'custom') {
            const hours = parseInt(data.custom_hours || 0);
            const minutes = parseInt(data.custom_minutes || 0);
            const seconds = parseInt(data.custom_seconds || 0);
            data.custom_seconds = hours * 3600 + minutes * 60 + seconds;
        }
        
        console.log('Submitting edit data:', data);
        
        // Submit to server
        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            loadingDiv.style.display = 'none';
            form.style.opacity = '1';
            
            if (result.success) {
                alert('‚úÖ Schedule updated successfully!');
                // Redirect to schedule manager
                window.location.href = '{{ url_for("schedule_new") }}';
            } else {
                alert('‚ùå Error: ' + (result.error || 'Unknown error occurred'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            loadingDiv.style.display = 'none';
            form.style.opacity = '1';
            alert('‚ùå Network error occurred. Please try again.');
        });
    });
});
</script>
{% endblock %}
