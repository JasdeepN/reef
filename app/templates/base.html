<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
     <title>{% block page_title %} {% endblock %}</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- <link rel="stylesheet" href="/static/css/style.css"> -->
    {% block styles %}
    
    {% endblock %}
    <!-- {{ bootstrap.load_css() }} -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" integrity="sha256-zzPh8NflvEInFbVSzLYGVMLOn0j0kfsjq/UlNeMBRYw=" crossorigin="anonymous">    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" integrity="sha512-jnSuA4Ss2PkkikSOLtYs8BlYIeeIK1h99ty4YfvRPAlzr377vr3CXDb7sb7eEEBYjDtcYj+AjBH3FLv5uSJuXg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="{{url_for('static',filename='css/main.css')}}" rel="stylesheet">
  
    
  </head>
  <body class="site">
   

  {% if tanks is not defined %}
    {% set tanks = [] %}
  {% endif %}

  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Reef DB</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="/">Home</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Tests
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/test">Results</a></li>
              <li><a class="dropdown-item" href="/test/add">New Test</a></li>
              <li><a class="dropdown-item" href="/test/icp">ICP</a></li>
              <li><a class="dropdown-item" href="/test/db">View Test DB</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Corals
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/coral/add">New</a></li>
              <li><a class="dropdown-item" href="/coral/update">Update</a></li>
              <li><a class="dropdown-item" href="/coral/view">View</a></li>
              <li><a class="dropdown-item" href="/coral/timeline">Add Snaphot</a></li>
            </ul>
          </li>  
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Doser
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/doser">ðŸ“Š Dashboard</a></li>
              <li><a class="dropdown-item" href="/doser/schedule/view">ðŸ“… View Schedules</a></li>
              <li><a class="dropdown-item" href="/doser/schedule/new">âž• New Schedule</a></li>
              <li><a class="dropdown-item" href="/doser/history">ðŸ“ˆ Dose History</a></li>
              <li><a class="dropdown-item" href="/doser/audit">ðŸ“Š Audit Log</a></li>
              <li><a class="dropdown-item" href="/doser/products">ðŸ“¦ Products</a></li>
            </ul>
          </li>
          </li>
           <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Models
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/models/view">View</a></li>
              <li><a class="dropdown-item" href="/models/tuning/alkalinity">Alkalinity Model</a></li>
              <li><a class="dropdown-item" href="/models/tuning/nitrate">Nitrate Model</a></li>
              <li><a class="dropdown-item" href="/models/tuning/phosphate">Phosphate Model</a></li>
              <li><a class="dropdown-item" href="/models/tuning/calcium">Calcium Model</a></li>
              <li><a class="dropdown-item" href="/models/tuning/Magnesium">Magnesium Model</a></li>

            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              X
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/metrics">Metrics</a></li>
              <li><a class="dropdown-item" href="/x/test">DB TEST</a></li>
              <li><a class="dropdown-item" href="/x/metrics">X/metrics</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('tank_system_list') }}">
              <i class="fas fa-fish"></i> Tank Management
            </a>
          </li>
          
          <!-- <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Dropdown
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">Action</a></li>
              <li><a class="dropdown-item" href="#">Another action</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#">Something else here</a></li>
            </ul>
          </li> 
          <li class="nav-item">
            <a class="nav-link disabled" aria-disabled="true">Disabled</a>
          </li> -->
        </ul>
        <div class="d-flex align-items-center ms-auto">
          <form id="system-select-form" class="d-flex" method="post" action="/set_system" style="margin-bottom:0;">
            <select class="form-select" id="system-select" name="system_id" style="min-width: 180px;" onchange="this.form.submit()">
              {% if not session.get('system_id') and not system_id %}
                <option value="" selected disabled>Select a system...</option>
              {% endif %}
              {% for tank_system in tank_systems %}
                <option value="{{ tank_system.id }}" {% if tank_system.id == session.get('system_id') or tank_system.id == system_id %}selected{% endif %}>{{ tank_system.name }}</option>
              {% endfor %}
            </select>
          </form>
        </div>
      </div>
    </div>
  </nav>

  <!-- Global Tank Context Modal - Only render for non-VS Code browsers when no tank is selected -->
  {% if not is_vscode_browser and tanks|length > 0 %}
  <div class="modal fade" id="tankContextModal" tabindex="-1" aria-labelledby="tankContextModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="tankContextModalLabel">
            <i class="fas fa-fish me-2"></i>Select Tank
          </h5>
        </div>
        <div class="modal-body">
          {% if tank_systems %}
            <p class="mb-3">Please select a tank system to continue using ReefDB. Your selection will be remembered for future visits.</p>
            <form id="system-context-form" method="post" action="/set_system">
              <div class="mb-3">
                <label for="modal-system-select" class="form-label">Available Systems:</label>
                <select class="form-select" id="modal-system-select" name="system_id" required>
                  <option value="">Choose a system...</option>
                  {% for tank_system in tank_systems %}
                    <option value="{{ tank_system.id }}">{{ tank_system.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-check me-2"></i>Select System
                </button>
                <a href="/tanks/new" class="btn btn-outline-success">
                  <i class="fas fa-plus me-2"></i>Add New Tank
                </a>
              </div>
            </form>
          {% else %}
            <div class="text-center">
              <i class="fas fa-fish text-muted mb-3" style="font-size: 3rem;"></i>
              <h5 class="text-muted">No Tanks Found</h5>
              <p class="mb-4">You need to create your first tank to get started with ReefDB.</p>
              <div class="d-grid">
                <a href="/tanks/new" class="btn btn-success btn-lg">
                  <i class="fas fa-plus me-2"></i>Create Your First Tank
                </a>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

    <!-- <script src="index.js"></script> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha256-ORBCb//WwUWwNh+EjsvO97snO3mAJ1+jhMzrlPBTYSQ=" crossorigin="anonymous"></script>
    <script src="{{url_for('static',filename='js/utils.js')}}"></script>
  {% block scripts %}  
<!-- Bootstrap 5 JavaScript -->

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js" integrity="sha512-ykZ1QQr0Jy/4ZkvKuqWn4iF3lqPZyij9iRv6sGqLRdTPkY69YX6+7wvVGmsdBbiIfN/8OdsI7HABjvEok6ZopQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
    <!-- {{ bootstrap.load_js() }} -->
  
   
  <!-- Tank Context JavaScript - Only load for non-VS Code browsers -->
  {% if not is_vscode_browser %}
  <script>
    // System Context Management - Regular Browsers Only
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[System Context] Page loaded for regular browser');
      
      // Basic system selector functionality
      const systemSelect = document.getElementById('system-select');
      if (systemSelect) {
        systemSelect.addEventListener('change', function() {
          const selectedSystemId = this.value;
          if (selectedSystemId) {
            // Store selection in localStorage if available
            try {
              localStorage.setItem('reefdb_system_id', selectedSystemId);
            } catch (e) {
              // localStorage not available, continue without it
            }
          }
        });
      }

      // Improved system context detection and automatic modal display
      const currentSystemId = systemSelect ? systemSelect.value : null;
      const hasOptions = systemSelect && systemSelect.options.length > 1;
      const modalElement = document.getElementById('tankContextModal');
      
      // Check if user has no system selected (empty value or "Select a system..." option)
      const noSystemSelected = !currentSystemId || currentSystemId === '' || currentSystemId === 'null';
      
      console.log('[System Context] Current system ID:', currentSystemId);
      console.log('[System Context] Has system options:', hasOptions);
      console.log('[System Context] No system selected:', noSystemSelected);
      console.log('[System Context] Modal element exists:', !!modalElement);
      
      // If no system is selected and systems are available, show the modal immediately
      if (noSystemSelected && hasOptions && modalElement) {
        console.log('[System Context] Showing system selection modal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
      
      // Handle system context form submission
      const systemContextForm = document.getElementById('system-context-form');
      if (systemContextForm) {
        systemContextForm.addEventListener('submit', function(e) {
          const selectedSystemId = document.getElementById('modal-system-select').value;
          if (!selectedSystemId) {
            e.preventDefault();
            alert('Please select a tank to continue');
            return;
          }
          
          // Store the selection
          try {
            localStorage.setItem('reefdb_system_id', selectedSystemId);
            console.log('[System Context] Stored system selection:', selectedSystemId);
          } catch (e) {
            console.warn('[Tank Context] Could not store in localStorage:', e);
          }
        });
      }
    });
  </script>
  {% endif %}
  {% endblock %}

  <div class="app-container">
    {% if title %}
      <h1>{{ title }}</h1>
    {% endif %}
  {% block content %} {% endblock %}
  </div>

  {% block page_scripts %}{% endblock %}

  <div class="footer">
    <footer>
      this is the footer
    </footer>
  </div>

  </body>
</html>