{% extends 'base.html' %}

{% block page_title %} Generic jqGrid Template {% endblock %}

{% block styles %}
  {{super()}}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/free-jqgrid/4.15.5/css/ui.jqgrid.min.css">
{% endblock %}

{% block scripts %}
  {{super()}}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/free-jqgrid/4.15.5/jquery.jqgrid.min.js"></script>
{% endblock %}

{% block content %}
<div class="table-container">
  <table id="{{ table_id }}"></table>
  <div id="{{ pager_id }}"></div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
  $(document).ready(function () {
    // Initialize jqGrid
    $("#{{ table_id }}").jqGrid({
      url: "{{ url }}", // Dynamic URL for fetching data
      datatype: "json",
      mtype: "GET",
      colModel: {{ col_model|safe }}, // Dynamic column model
      pager: "#{{ pager_id }}",
      rowNum: 10,
      rowList: [10, 20, 30],
      sortname: "id",
      sortorder: "asc",
      viewrecords: true,
      caption: "{{ caption }}", // Dynamic table caption
      height: "auto",
      width: "100%",
      shrinkToFit: true,
      editurl: "{{ edit_url }}", // Dynamic URL for editing data
    });

    // Add navigation buttons to the pager
    $("#{{ table_id }}").jqGrid("navGrid", "#{{ pager_id }}", {
      edit: false, // Disable default edit button
      add: false, // Disable default add button
      del: false, // Disable default delete button
      search: false, // Disable default search button
      refresh: true, // Enable refresh button
    });

    // Add custom "Add" button
    $("#{{ table_id }}").jqGrid("navButtonAdd", "#{{ pager_id }}", {
      caption: "Add",
      buttonicon: "ui-icon-plus",
      onClickButton: function () {
        alert("Add button clicked for {{ table_id }}!");
        // Add your custom logic for adding a row here
      },
      position: "last",
      title: "Add a new entry",
      cursor: "pointer",
    });

    // Add custom "Delete" button
    $("#{{ table_id }}").jqGrid("navButtonAdd", "#{{ pager_id }}", {
      caption: "Delete",
      buttonicon: "ui-icon-trash",
      onClickButton: function () {
        const selectedRowId = $("#{{ table_id }}").jqGrid("getGridParam", "selrow");
        if (selectedRowId) {
          if (confirm("Are you sure you want to delete this record?")) {
            $.ajax({
              url: "{{ delete_url }}", // Dynamic URL for deleting data
              type: "DELETE",
              contentType: "application/json",
              data: JSON.stringify({ id: selectedRowId }),
              success: function () {
                alert("Record deleted successfully!");
                $("#{{ table_id }}").trigger("reloadGrid");
              },
              error: function (xhr) {
                alert("Error deleting record: " + xhr.responseText);
              },
            });
          }
        } else {
          alert("Please select a row to delete.");
        }
      },
      position: "last",
      title: "Delete the selected entry",
      cursor: "pointer",
    });

    // Adjust grid and pager width dynamically
    $(window).on("resize", function () {
      const gridParent = $("#{{ table_id }}").closest(".table-container");
      if (gridParent.length) {
        const parentWidth = gridParent.width();
        $("#{{ table_id }}").jqGrid("setGridWidth", parentWidth);
        $("#{{ pager_id }}").css("width", `${parentWidth}px`);
      }
    }).trigger("resize");
  });
</script>
{% endblock %}

