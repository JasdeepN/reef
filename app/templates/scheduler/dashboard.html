{% extends 'base.html' %}

{% block page_title %}Dosing Scheduler Dashboard{% endblock %}

{% block content %}
<div class="container-fluid scheduler-dashboard">
  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <h1>ü§ñ Automated Dosing Scheduler</h1>
    <p>Monitor and control the automated dosing system for {{ system_name }}</p>
  </div>

  <!-- Scheduler Status Cards -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 col-sm-12">
      <div class="card">
        <div class="card-body text-center">
          <div class="scheduler-status-indicator" id="status-indicator">
            <i class="fas fa-circle text-secondary fa-2x"></i>
          </div>
          <h5 class="card-title mt-2">Scheduler Status</h5>
          <p class="card-text" id="status-text">Loading...</p>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 col-sm-12">
      <div class="card">
        <div class="card-body text-center">
          <div class="scheduler-metric">
            <i class="fas fa-clock fa-2x text-info"></i>
          </div>
          <h5 class="card-title mt-2">Check Interval</h5>
          <p class="card-text" id="check-interval">Loading...</p>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 col-sm-12">
      <div class="card">
        <div class="card-body text-center">
          <div class="scheduler-metric">
            <i class="fas fa-calendar-alt fa-2x text-warning"></i>
          </div>
          <h5 class="card-title mt-2">Due Doses</h5>
          <p class="card-text" id="due-count">Loading...</p>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 col-sm-12">
      <div class="card">
        <div class="card-body text-center">
          <div class="scheduler-metric">
            <i class="fas fa-history fa-2x text-success"></i>
          </div>
          <h5 class="card-title mt-2">Last Check</h5>
          <p class="card-text" id="last-check">Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Control Panel -->
  <div class="row mb-4">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">üéõÔ∏è Scheduler Controls</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-2">
              <button id="start-btn" class="btn btn-success w-100" onclick="startScheduler()">
                <i class="fas fa-play"></i> Start
              </button>
            </div>
            <div class="col-md-3 mb-2">
              <button id="stop-btn" class="btn btn-danger w-100" onclick="stopScheduler()">
                <i class="fas fa-stop"></i> Stop
              </button>
            </div>
            <div class="col-md-3 mb-2">
              <button id="restart-btn" class="btn btn-warning w-100" onclick="restartScheduler()">
                <i class="fas fa-redo"></i> Restart
              </button>
            </div>
            <div class="col-md-3 mb-2">
              <button id="check-btn" class="btn btn-info w-100" onclick="forceCheck()">
                <i class="fas fa-search"></i> Check Now
              </button>
            </div>
          </div>
          <div class="mt-3">
            <small class="text-muted">
              Use these controls to manage the automated dosing scheduler. 
              The scheduler runs in the background and automatically triggers doses when they're due.
            </small>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0">üìä Quick Stats</h6>
        </div>
        <div class="card-body">
          <div class="scheduler-stats">
            <div class="d-flex justify-content-between mb-2">
              <span>Total Schedules:</span>
              <span id="total-schedules">-</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Active Schedules:</span>
              <span id="active-schedules">-</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Suspended:</span>
              <span id="suspended-schedules">-</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Low Products:</span>
              <span id="low-products">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Due Doses Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">‚è∞ Currently Due Doses</h5>
        </div>
        <div class="card-body">
          <div id="due-doses-container">
            <div class="text-center text-muted">
              <i class="fas fa-spinner fa-spin fa-2x"></i>
              <p class="mt-2">Loading due doses...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Upcoming Doses Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">üîÆ Next 3 Scheduled Doses</h5>
        </div>
        <div class="card-body">
          <div id="upcoming-doses-container">
            <div class="text-center text-muted">
              <i class="fas fa-spinner fa-spin fa-2x"></i>
              <p class="mt-2">Loading upcoming doses...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Configuration Display -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-secondary text-white">
          <h6 class="mb-0">‚öôÔ∏è Configuration</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <strong>Enabled:</strong> <span id="config-enabled">-</span>
            </div>
            <div class="col-md-3">
              <strong>Check Interval:</strong> <span id="config-interval">-</span>
            </div>
            <div class="col-md-3">
              <strong>Timezone:</strong> <span id="config-timezone">-</span>
            </div>
            <div class="col-md-3">
              <strong>Base URL:</strong> <span id="config-url">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Notification Area -->
<div id="notification-area" class="position-fixed" style="top: 20px; right: 20px; z-index: 1050;"></div>

<script>
// API URLs passed from Flask
const apiUrls = {{ api_urls | tojson }};
let refreshInterval;

document.addEventListener('DOMContentLoaded', function() {
  loadSchedulerStatus();
  loadDueDoses();
  loadScheduleStats();
  
  // Refresh every 30 seconds
  refreshInterval = setInterval(function() {
    loadSchedulerStatus();
    loadDueDoses();
  }, 30000);
});

function loadSchedulerStatus() {
  fetch(apiUrls.status)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        updateStatusDisplay(data.status, data.config);
      } else {
        showNotification('Error loading scheduler status: ' + data.error, 'error');
      }
    })
    .catch(error => {
      console.error('Error loading scheduler status:', error);
      showNotification('Network error loading scheduler status', 'error');
    });
}

function updateStatusDisplay(status, config) {
  const statusIndicator = document.getElementById('status-indicator');
  const statusText = document.getElementById('status-text');
  const lastCheck = document.getElementById('last-check');
  
  // Update status indicator - check for status.status === "running"
  if (status.status === 'running') {
    statusIndicator.innerHTML = '<i class="fas fa-circle text-success fa-2x"></i>';
    statusText.textContent = 'Running';
    document.getElementById('start-btn').disabled = true;
    document.getElementById('stop-btn').disabled = false;
    document.getElementById('check-btn').disabled = false;
  } else {
    statusIndicator.innerHTML = '<i class="fas fa-circle text-danger fa-2x"></i>';
    statusText.textContent = 'Stopped';
    document.getElementById('start-btn').disabled = false;
    document.getElementById('stop-btn').disabled = true;
    document.getElementById('check-btn').disabled = true;
  }
  
  // Update configuration display
  document.getElementById('config-enabled').textContent = config.enabled ? 'Yes' : 'No';
  document.getElementById('config-interval').textContent = config.check_interval + 's';
  document.getElementById('config-timezone').textContent = config.timezone;
  document.getElementById('config-url').textContent = config.base_url;
  document.getElementById('check-interval').textContent = config.check_interval + ' seconds';
  
  // Update last check time
  if (status.last_check) {
    const lastCheckTime = new Date(status.last_check);
    lastCheck.textContent = lastCheckTime.toLocaleString();
  } else {
    lastCheck.textContent = 'Never';
  }
  
  // Update upcoming doses if available
  if (status.next_doses) {
    updateUpcomingDosesDisplay(status.next_doses);
  }
}

function loadDueDoses() {
  fetch(apiUrls.due)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        updateDueDosesDisplay(data.due_schedules);
        document.getElementById('due-count').textContent = data.count;
      } else {
        document.getElementById('due-count').textContent = 'Error';
        showNotification('Error loading due doses: ' + data.error, 'error');
      }
    })
    .catch(error => {
      console.error('Error loading due doses:', error);
      document.getElementById('due-count').textContent = 'Error';
    });
}

function updateDueDosesDisplay(dueSchedules) {
  const container = document.getElementById('due-doses-container');
  
  if (dueSchedules.length === 0) {
    container.innerHTML = `
      <div class="text-center text-muted">
        <i class="fas fa-check-circle fa-2x text-success"></i>
        <p class="mt-2">No doses are currently due</p>
      </div>
    `;
    return;
  }
  
  const html = dueSchedules.map(schedule => `
    <div class="due-dose-card mb-2 p-3 border rounded">
      <div class="row align-items-center">
        <div class="col-md-4">
          <strong>${schedule.product_name}</strong><br>
          <small class="text-muted">Schedule ${schedule.id}</small>
        </div>
        <div class="col-md-2">
          <span class="badge bg-warning">${schedule.amount}ml</span>
        </div>
        <div class="col-md-3">
          ${schedule.seconds_missed ? 
            `<span class="text-danger">Missed by ${Math.floor(schedule.seconds_missed / 60)}m</span>` :
            '<span class="text-warning">Due now</span>'
          }
        </div>
        <div class="col-md-3">
          <small class="text-muted">
            Available: ${schedule.current_avail}ml<br>
            Schedule ID: ${schedule.schedule_id}
          </small>
        </div>
      </div>
    </div>
  `).join('');
  
  container.innerHTML = html;
}

function updateUpcomingDosesDisplay(nextDoses) {
  const container = document.getElementById('upcoming-doses-container');
  
  if (!nextDoses || nextDoses.length === 0) {
    container.innerHTML = `
      <div class="text-center text-muted">
        <i class="fas fa-clock fa-2x"></i>
        <p class="mt-2">No upcoming doses scheduled</p>
      </div>
    `;
    return;
  }

  const html = nextDoses.map((dose, index) => {
    const scheduledTime = new Date(dose.scheduled_time);
    const now = new Date();
    const timeUntil = Math.max(0, Math.floor((scheduledTime - now) / 1000));
    
    const hours = Math.floor(timeUntil / 3600);
    const minutes = Math.floor((timeUntil % 3600) / 60);
    const seconds = timeUntil % 60;
    
    let timeDisplay;
    let colorClass = '';
    
    if (timeUntil < 300) { // Less than 5 minutes
      timeDisplay = `${minutes}m ${seconds}s`;
      colorClass = 'text-danger';
    } else if (timeUntil < 3600) { // Less than 1 hour
      timeDisplay = `${minutes}m`;
      colorClass = 'text-warning';
    } else if (timeUntil < 86400) { // Less than 1 day
      timeDisplay = `${hours}h ${minutes}m`;
      colorClass = 'text-info';
    } else {
      const days = Math.floor(timeUntil / 86400);
      const remainingHours = Math.floor((timeUntil % 86400) / 3600);
      timeDisplay = `${days}d ${remainingHours}h`;
      colorClass = 'text-success';
    }
    
    return `
      <div class="upcoming-dose-card mb-3 p-3 border rounded ${index === 0 ? 'border-primary' : ''}">
        <div class="row align-items-center">
          <div class="col-md-4">
            <h6 class="mb-0 text-primary">${dose.product_name}</h6>
            <small class="text-muted">Schedule ${dose.schedule_id || dose.id}</small>
          </div>
          <div class="col-md-2">
            <span class="badge bg-primary">${dose.amount}ml</span>
          </div>
          <div class="col-md-3">
            <div class="dose-timing">
              <div class="fw-bold ${colorClass}">${timeDisplay}</div>
              <div class="text-muted small">
                ${scheduledTime.toLocaleDateString()} ${scheduledTime.toLocaleTimeString()}
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <small class="text-muted">
              ${index === 0 ? 'ü•á Next' : index === 1 ? 'ü•à After' : 'ü•â Then'}
            </small>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

function loadScheduleStats() {
  fetch(apiUrls.schedules)
    .then(response => response.json())
    .then(data => {
      if (data.success && data.data) {
        const schedules = data.data;
        const total = schedules.length;
        const suspended = schedules.filter(s => s.suspended && s.suspended[1]).length;
        const active = total - suspended;
        const lowProducts = schedules.filter(s => {
          const percent = s.percent_remaining && s.percent_remaining[1];
          return percent !== null && percent < 20;
        }).length;
        
        document.getElementById('total-schedules').textContent = total;
        document.getElementById('active-schedules').textContent = active;
        document.getElementById('suspended-schedules').textContent = suspended;
        document.getElementById('low-products').textContent = lowProducts;
      }
    })
    .catch(error => {
      console.error('Error loading schedule stats:', error);
    });
}

function startScheduler() {
  controlScheduler('start', 'Starting scheduler...');
}

function stopScheduler() {
  controlScheduler('stop', 'Stopping scheduler...');
}

function restartScheduler() {
  controlScheduler('restart', 'Restarting scheduler...');
}

function forceCheck() {
  controlScheduler('check', 'Triggering manual check...', 'Manual dose check triggered successfully');
}

function controlScheduler(action, loadingMessage, successMessage = null) {
  showNotification(loadingMessage, 'info');
  
  fetch(apiUrls[action], { method: 'POST' })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(successMessage || data.message, 'success');
        // Refresh status after a short delay
        setTimeout(loadSchedulerStatus, 1000);
        if (action === 'check') {
          setTimeout(loadDueDoses, 2000);
        }
      } else {
        showNotification('Error: ' + data.error, 'error');
      }
    })
    .catch(error => {
      console.error(`Error with ${action}:`, error);
      showNotification(`Network error during ${action}`, 'error');
    });
}

function showNotification(message, type) {
  const notificationArea = document.getElementById('notification-area');
  const alertClass = type === 'success' ? 'alert-success' : 
                    type === 'error' ? 'alert-danger' : 
                    type === 'warning' ? 'alert-warning' : 'alert-info';
  
  const notification = document.createElement('div');
  notification.className = `alert ${alertClass} alert-dismissible fade show`;
  notification.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  notificationArea.appendChild(notification);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 5000);
}

// Cleanup interval on page unload
window.addEventListener('beforeunload', function() {
  if (refreshInterval) {
    clearInterval(refreshInterval);
  }
});

// Scheduler control functions
function startScheduler() {
  controlScheduler('start', 'Starting scheduler...', 'Scheduler started successfully');
}

function stopScheduler() {
  controlScheduler('stop', 'Stopping scheduler...', 'Scheduler stopped successfully');
}

function restartScheduler() {
  controlScheduler('restart', 'Restarting scheduler...', 'Scheduler restarted successfully');
}

function forceCheck() {
  controlScheduler('check', 'Triggering manual dose check...', 'Manual dose check completed');
}
</script>

<style>
.scheduler-dashboard {
  padding: 2rem 1rem;
}

.dashboard-header {
  text-align: center;
  margin-bottom: 2rem;
}

.dashboard-header h1 {
  color: var(--text-color);
  margin-bottom: 0.5rem;
}

.dashboard-header p {
  color: var(--text-muted);
  margin-bottom: 0;
}

.scheduler-status-indicator {
  margin-bottom: 1rem;
}

.scheduler-metric {
  margin-bottom: 1rem;
}

.due-dose-card {
  background-color: var(--card-bg);
  border-color: var(--border-color) !important;
}

.scheduler-stats {
  font-size: 0.9rem;
}

.card {
  background-color: var(--card-bg);
  border-color: var(--border-color);
  color: var(--text-color);
}

.card-header {
  border-bottom-color: var(--border-color);
}

.card-body {
  color: var(--text-color);
}

.text-muted {
  color: var(--text-muted) !important;
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

#notification-area .alert {
  margin-bottom: 0.5rem;
  min-width: 300px;
}
</style>
{% endblock %}
