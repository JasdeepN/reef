{% extends 'jqgrid-template.html' %}

{% block page_title %} test page {% endblock %}

{% block styles %}
  {{super()}}
 {% endblock %}

{% block content %} 
<div class="applet-container">
  <div class="grid-container">
    <div class="grid-item full-width">
      <div class="title">
        <h3>Test Results Table</h3>
      </div>
      <div class="content table-container">
        <div id="testResultGridbox">
          <table id="test_ResultsTable"></table>
          <div id="test_ResultsTablePager"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- more containers could go here -->
</div>


{% endblock %}

{% block page_scripts %}
  {{super()}}
  <script>
    $(document).ready(function () {
      // Initialize jqGrid
      $("#test_ResultsTable").jqGrid({
        url: "/api/get/test_results", // Backend endpoint to fetch data
        datatype: "json",
        mtype: "GET",
        colModel: [
          { label: "Test Date", name: "test_date", editable: true, sorttype: "date", align: "center",
            formatter: "date",
            formatoptions: {
              newformat: "Y-m-d",
              srcformat: "Y-m-d",
            },
            align: "center",
          },
          { label: "Test Time", name: "test_time", editable: true, align: "center",
          },
          { label: "Alkalinity (KH)", name: "alk",
            editable: true,
            formatter:'number',
            formatoptions: {
              decimalPlaces: 1,
              defaultValue: '',
            },
            align: "center",
          },
          { label: "PO\u2084\u00b3\u207b ppm", name: "po4_ppm",
            editable: false,
            cellattr : function (value, options, rowObject) {
              return 'style="background-color: #606060; color: #FFFFFF;"';
            },
            formatter:'number',
            formatoptions: {
              decimalPlaces: 3,
              defaultValue: '',
            },
            align: "center",
          },
          { label: "PO\u2084\u00b3\u207b ppb", name: "po4_ppb", editable: true,
            formatter:'number',
            formatoptions: {
              decimalPlaces: 0,
              defaultValue: '',
            },
            align: "center",
          },
          { label: "NO\u2083\u207b ppm", name: "no3_ppm", editable: true, align: "center",},
          { label: "Ca\u00b2\u207a ppm", name: "cal", editable: true, align: "center",},
          { label: "Mg\u00b2\u207a ppm ", name: "mg", editable: true, align: "center",},
          { label: "Specific Gravity (SG)", name: "sg", editable: true,
            formatter:'number',
            formatoptions: {
              decimalPlaces: 3,
              defaultValue: '',
            },
            align: "center",
          },
        ],
        pager: "#test_ResultsTablePager",
        rowNum: 15,
        rowList: [15, 30, 45],
        sortname: "test_date",
        sortorder: "desc",
        viewrecords: true,
        caption: "Editable Test Results Table",
        editurl: "/api/edit_test_results", // Backend endpoint for editing data
      });

      // Add navigation buttons to the Test Results Table pager
      $("#test_ResultsTable").jqGrid("navGrid", "#test_ResultsTablePager", {
        edit: false, // Disable default edit button
        add: false, // Disable default add button
        del: false, // Disable default delete button
        search: false, // Disable default search button
        refresh: true, // Enable refresh button
      });

      // Add custom "Add" button
      $("#test_ResultsTable").jqGrid("navButtonAdd", "#test_ResultsTablePager", {
        caption: "Add",
        buttonicon: "ui-icon-plus",
        onClickButton: function () {
          alert("Add button clicked for Test Results Table!");
          // Add your custom logic for adding a row here
        },
        position: "last",
        title: "Add a new test result",
        cursor: "pointer",
      });

      // Add custom "Delete" button
      $("#test_ResultsTable").jqGrid("navButtonAdd", "#test_ResultsTablePager", {
        caption: "Delete",
        buttonicon: "ui-icon-trash",
        onClickButton: function () {
          const selectedRowId = $("#test_ResultsTable").jqGrid("getGridParam", "selrow");
          if (selectedRowId) {
            if (confirm("Are you sure you want to delete this record?")) {
              $.ajax({
                url: "/api/edit_test_results",
                type: "DELETE",
                contentType: "application/json",
                data: JSON.stringify({ id: selectedRowId }),
                success: function () {
                  alert("Record deleted successfully!");
                  $("#test_ResultsTable").trigger("reloadGrid");
                },
                error: function (xhr) {
                  alert("Error deleting record: " + xhr.responseText);
                },
              });
            }
          } else {
            alert("Please select a row to delete.");
          }
        },
        position: "last",
        title: "Delete the selected test result",
        cursor: "pointer",
      });
    });
  </script>
{% endblock %}