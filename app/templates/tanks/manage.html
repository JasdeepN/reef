{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <!-- Tank Management Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="dashboard-header">
        <h1 class="text-center">Tank Management</h1>
        <p class="text-center text-muted">Manage your reef tanks and configurations</p>
      </div>
    </div>
  </div>

  <!-- Add New Tank Button -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <a href="{{ url_for('tank_new') }}" class="btn btn-primary btn-lg">
        <i class="fas fa-plus"></i> Add New Tank
      </a>
    </div>
  </div>

  <!-- Tanks Display -->
  <div class="row">
{% if tank_stats %}
  {% for stat in tank_stats %}
  {% set tank = stat.tank %}
  <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
    <div class="card tank-card {% if tank.id == current_tank_id %}current-tank{% endif %}">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <h5 class="card-title mb-0">{{ tank.name }}</h5>
          {% if tank.id == current_tank_id %}
            <span class="badge bg-success">Current Tank</span>
          {% endif %}
        </div>
        {% if tank.description %}
        <p class="card-text text-muted">{{ tank.description }}</p>
        {% endif %}

        <!-- Water Volumes -->
        <p class="card-text mb-1">
          <small class="text-muted">
            <i class="fas fa-water"></i>
            Gross: {{ stat.gross_water_vol or '—' }} gal
            &nbsp;|&nbsp;
            Net: {{ stat.net_water_vol or '—' }} gal
          </small>
        </p>

        <!-- Overall Health -->
        <p class="card-text mb-1">
          <small class="text-muted">
            <i class="fas fa-heartbeat"></i>
            Health: <strong>{{ stat.overall_health }}</strong>
            {% if stat.coral_health_counts and stat.coral_health_counts|length > 1 %}
              <span class="ms-2" title="Coral health breakdown">
                ({{ stat.coral_health_counts | map(attribute='0') | join(', ') }})
              </span>
            {% endif %}
          </small>
        </p>

        <!-- Dosing Status -->
        <p class="card-text mb-1">
          <small class="text-muted">
            <i class="fas fa-vial"></i>
            Dosing: <span title="Active / Suspended / Overdue">
              <strong>{{ stat.dosing_active }}</strong> active,
              <strong>{{ stat.dosing_suspended }}</strong> suspended,
              <strong>{{ stat.dosing_missed }}</strong> missed
            </span>
          </small>
        </p>

        <div class="card-actions mt-3">
          <a href="{{ url_for('tank_edit', tank_id=tank.id) }}" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-edit"></i> Edit
          </a>
          {% if tank.id != current_tank_id %}
          <button type="button" class="btn btn-outline-danger btn-sm" 
                  data-bs-toggle="modal" 
                  data-bs-target="#deleteTankModal"
                  data-tank-id="{{ tank.id }}"
                  data-tank-name="{{ tank.name }}">
            <i class="fas fa-trash"></i> Delete
          </button>
          {% else %}
          <button type="button" class="btn btn-outline-secondary btn-sm" disabled>
            <i class="fas fa-trash"></i> Cannot Delete Current Tank
          </button>
          {% endif %}
          {% if tank.id != current_tank_id %}
          <form action="{{ url_for('set_tank') }}" method="post" class="d-inline">
            <input type="hidden" name="tank_id" value="{{ tank.id }}">
            <button type="submit" class="btn btn-outline-success btn-sm">
              <i class="fas fa-check"></i> Select Tank
            </button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
{% else %}
      <!-- Empty State -->
      <div class="col-12">
        <div class="empty-state text-center py-5">
          <div class="empty-state-icon mb-4">
            <i class="fas fa-fish fa-4x text-muted"></i>
          </div>
          <h3 class="text-muted mb-3">No Tanks Found</h3>
          <p class="text-muted mb-4">You haven't created any tanks yet. Get started by adding your first reef tank!</p>
          <a href="{{ url_for('tank_new') }}" class="btn btn-primary btn-lg">
            <i class="fas fa-plus"></i> Create Your First Tank
          </a>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Delete Tank Confirmation Modal -->
<div class="modal fade" id="deleteTankModal" tabindex="-1" aria-labelledby="deleteTankModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteTankModalLabel">Delete Tank</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the tank <strong id="tank-name-display"></strong>?</p>
        <p class="text-danger"><small><i class="fas fa-exclamation-triangle"></i> This action cannot be undone.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="delete-tank-form" action="" method="post" class="d-inline">
          <button type="submit" class="btn btn-danger">Delete Tank</button>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
.tank-card {
  background-color: var(--card-bg);
  border: 1px solid var(--border-color);
  transition: transform 0.2s, box-shadow 0.2s;
}

.tank-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.tank-card.current-tank {
  border-color: #28a745;
  box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
}

.card-title {
  color: var(--text-color);
}

.card-text {
  color: var(--text-muted);
}

.empty-state {
  padding: 4rem 2rem;
}

.empty-state-icon {
  opacity: 0.6;
}

.dashboard-header {
  padding: 2rem 1.5rem;
  margin-bottom: 2rem;
  text-align: center;
}

.dashboard-header h1 {
  color: var(--text-color);
  margin-bottom: 0.5rem;
}

.dashboard-header p {
  color: var(--text-muted);
  margin-bottom: 0;
}

.card-actions .btn {
  margin-right: 0.5rem;
  margin-bottom: 0.5rem;
}

.badge {
  font-size: 0.75em;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle delete tank modal
  const deleteTankModal = document.getElementById('deleteTankModal');
  if (deleteTankModal) {
    deleteTankModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const tankId = button.getAttribute('data-tank-id');
      const tankName = button.getAttribute('data-tank-name');
      
      const tankNameDisplay = deleteTankModal.querySelector('#tank-name-display');
      const deleteForm = deleteTankModal.querySelector('#delete-tank-form');
      
      tankNameDisplay.textContent = tankName;
      deleteForm.action = `/tanks/delete/${tankId}`;
    });
  }
});
</script>
{% endblock %}