{% extends "base.html" %}

{% block page_title %}Add New Tank - ReefDB{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tank-forms.css') }}">
{% endblock %}

{% block content %}
<div class="container tank-form-page">
  <div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">
      <!-- Header -->
      <div class="form-header">
        <h1>Add New Tank</h1>
        <p>Create a new reef tank configuration</p>
      </div>

      <!-- Tank Creation Form -->
      <div class="card tank-form-card">
        <div class="card-body">
          <form action="{{ url_for('tank_new') }}" method="post" novalidate>
            <!-- Tank Name -->
            <div class="tank-form-group">
              <label for="name" class="form-label">Tank Name <span class="text-danger">*</span></label>
              <input type="text" 
                     class="form-control" 
                     id="name" 
                     name="name" 
                     placeholder="e.g., Main Display Tank, Quarantine Tank"
                     required
                     maxlength="100">
              <div class="form-text">Choose a descriptive name for your tank</div>
            </div>

            <!-- Gross Water Volume -->
            <div class="tank-form-group">
              <label for="gross_water_vol" class="form-label">Gross Water Volume (Gallons)</label>
              <input type="number" 
                     class="form-control" 
                     id="gross_water_vol" 
                     name="gross_water_vol" 
                     placeholder="e.g., 55, 120, 180"
                     min="0" 
                     max="10000"
                     step="1">
              <div class="form-text">Total tank volume including displacement from rock and equipment</div>
            </div>

            <!-- Net Water Volume -->
            <div class="tank-form-group">
              <label for="net_water_vol" class="form-label">Net Water Volume (Gallons)</label>
              <input type="number" 
                     class="form-control" 
                     id="net_water_vol" 
                     name="net_water_vol" 
                     placeholder="e.g., 50, 110, 165"
                     min="0" 
                     max="10000"
                     step="1">
              <div class="form-text">Actual water volume after rock and equipment displacement</div>
            </div>

            <!-- Live Rock Weight -->
            <div class="tank-form-group">
              <label for="live_rock_lbs" class="form-label">Live Rock Weight (lbs)</label>
              <input type="number" 
                     class="form-control" 
                     id="live_rock_lbs" 
                     name="live_rock_lbs" 
                     placeholder="e.g., 45, 80, 120"
                     min="0" 
                     max="1000"
                     step="0.1">
              <div class="form-text">Weight of live rock in pounds (used for biological load calculations)</div>
            </div>

            <!-- Tank Dimensions Section -->
            <div class="tank-form-group">
              <h6 class="form-section-header">Tank Dimensions</h6>
              <div class="row">
                <div class="col-md-4">
                  <label for="tank_length_inches" class="form-label">Length (inches)</label>
                  <input type="number" 
                         class="form-control" 
                         id="tank_length_inches" 
                         name="tank_length_inches" 
                         placeholder="e.g., 48, 72, 96"
                         min="0" 
                         max="300"
                         step="0.1">
                </div>
                <div class="col-md-4">
                  <label for="tank_width_inches" class="form-label">Width (inches)</label>
                  <input type="number" 
                         class="form-control" 
                         id="tank_width_inches" 
                         name="tank_width_inches" 
                         placeholder="e.g., 18, 24, 30"
                         min="0" 
                         max="100"
                         step="0.1">
                </div>
                <div class="col-md-4">
                  <label for="tank_height_inches" class="form-label">Height (inches)</label>
                  <input type="number" 
                         class="form-control" 
                         id="tank_height_inches" 
                         name="tank_height_inches" 
                         placeholder="e.g., 20, 24, 30"
                         min="0" 
                         max="100"
                         step="0.1">
                </div>
              </div>
              <div class="form-text">Tank dimensions for space planning and equipment sizing</div>
            </div>

            <!-- Sump Volume -->
            <div class="tank-form-group">
              <label for="sump_volume_gallons" class="form-label">Sump Volume (Gallons)</label>
              <input type="number" 
                     class="form-control" 
                     id="sump_volume_gallons" 
                     name="sump_volume_gallons" 
                     placeholder="e.g., 20, 40, 75"
                     min="0" 
                     max="1000"
                     step="0.1">
              <div class="form-text">Volume of sump/refugium for total system water calculation</div>
            </div>

            <!-- Tank System -->
            <div class="tank-form-group">
              <label for="tank_system_id" class="form-label">Tank System (Optional)</label>
              <select class="form-select" id="tank_system_id" name="tank_system_id">
                <option value="">Standalone Tank (No System)</option>
                {% if tank_systems %}
                  {% for system in tank_systems %}
                  <option value="{{ system.id }}">{{ system.name }} 
                    ({{ system.get_tank_count() }} tanks, {{ system.calculate_total_system_volume() }} gal total)</option>
                  {% endfor %}
                {% endif %}
              </select>
              <div class="form-text">
                Assign this tank to a multi-tank system for shared equipment and volume calculations.
                <a href="{{ url_for('tank_system_new') }}" target="_blank" class="text-decoration-none">
                  <i class="fas fa-plus"></i> Create New System
                </a>
              </div>
            </div>

            <!-- Description -->
            <div class="tank-form-group">
              <label for="description" class="form-label">Description/Notes</label>
              <textarea class="form-control" 
                        id="description" 
                        name="description" 
                        rows="3" 
                        placeholder="Optional notes about this tank setup, equipment, or configuration..."></textarea>
              <div class="form-text">Additional information about this tank (optional)</div>
            </div>

            <!-- Form Actions -->
            <div class="tank-form-actions">
              <a href="{{ url_for('tank_manage') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Tank Management
              </a>
              <button type="submit" class="btn btn-success">
                <i class="fas fa-plus me-2"></i>Create Tank
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Help Text -->
      <div class="mt-4 text-center">
        <small class="text-muted">
          <i class="fas fa-info-circle"></i> 
          If this is your first tank, it will automatically be selected as your active tank.
        </small>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Form validation enhancement
  const form = document.querySelector('form');
  const nameInput = document.getElementById('name');
  
  // Add loading state to form submission
  form.addEventListener('submit', function(e) {
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Basic validation
    let isValid = true;
    
    if (!nameInput.value.trim()) {
      showFieldError(nameInput, 'Tank name is required');
      isValid = false;
    } else {
      clearFieldError(nameInput);
    }
    
    if (isValid) {
      // Show loading state
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Tank...';
      submitBtn.disabled = true;
      form.classList.add('form-loading');
    } else {
      e.preventDefault();
    }
  });
  
  // Real-time validation
  nameInput.addEventListener('blur', function() {
    if (!this.value.trim()) {
      showFieldError(this, 'Tank name is required');
    } else {
      clearFieldError(this);
    }
  });
  
  // Auto-calculate net volume based on gross volume (rough estimate)
  const grossVolInput = document.getElementById('gross_water_vol');
  const netVolInput = document.getElementById('net_water_vol');
  
  grossVolInput.addEventListener('blur', function() {
    if (this.value && !netVolInput.value) {
      // Rough estimate: net volume is typically 85-90% of gross volume
      const grossVol = parseFloat(this.value);
      const estimatedNet = Math.round(grossVol * 0.87);
      netVolInput.value = estimatedNet;
      netVolInput.style.backgroundColor = 'rgba(46, 204, 113, 0.1)';
      
      // Add a subtle hint that this is estimated
      const hintText = netVolInput.parentNode.querySelector('.form-text');
      if (hintText) {
        hintText.innerHTML = 'Actual water volume after rock and equipment displacement <small class="text-success">(auto-estimated)</small>';
      }
    }
  });
  
  function showFieldError(field, message) {
    field.classList.add('is-invalid');
    
    // Remove existing error message
    const existingError = field.parentNode.querySelector('.invalid-feedback');
    if (existingError) {
      existingError.remove();
    }
    
    // Add new error message
    const errorDiv = document.createElement('div');
    errorDiv.className = 'invalid-feedback';
    errorDiv.textContent = message;
    field.parentNode.appendChild(errorDiv);
  }
  
  function clearFieldError(field) {
    field.classList.remove('is-invalid');
    const errorDiv = field.parentNode.querySelector('.invalid-feedback');
    if (errorDiv) {
      errorDiv.remove();
    }
  }
  
  // Add focus animations
  const formControls = document.querySelectorAll('.form-control, .form-select');
  formControls.forEach(control => {
    control.addEventListener('focus', function() {
      this.parentNode.classList.add('focused');
    });
    
    control.addEventListener('blur', function() {
      this.parentNode.classList.remove('focused');
    });
  });
});
</script>
{% endblock %}
